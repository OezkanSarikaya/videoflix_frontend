name: Test FTP Connection

on:
  push:
    branches:
      - main  # Passe dies an deine Haupt-Branch an

jobs:
  test-ftp:
    runs-on: ubuntu-latest

    steps:
      - name: 🛠 Installiere FTP-Clients
        run: sudo apt-get update && sudo apt-get install -y lftp ftp

      - name: 🔍 Test Verbindung mit FTP (Unsicher, nur Debugging)
        run: |
          echo "TEST FTP CONNECTION (Plain FTP)"
          ftp -inv ${{ secrets.FTP_HOST }} << EOF
          user ${{ secrets.FTP_USER }} ${{ secrets.FTP_KEY }}
          bye
          EOF

      - name: 🔍 Test Verbindung mit lftp (Explizites FTPS, Zertifikat ignorieren)
        run: |
          echo "TEST FTP CONNECTION (lftp, Explicit FTPS, ignore cert)"
          lftp -d -u "${{ secrets.FTP_USER }},${{ secrets.FTP_KEY }}" ${{ secrets.FTP_HOST }} << EOF
          set ftp:ssl-force true
          set ftp:ssl-protect-data true
          set ssl:verify-certificate no
          set ftp:use-host 0  # <<< WICHTIG: HOST-Befehl deaktivieren
          connect ${{ secrets.FTP_HOST }}
          ls
          bye
          EOF

      - name: 🔍 Test Verbindung mit lftp (FTP)
        run: |
          echo "TEST FTP CONNECTION (lftp, Plain FTP)"
          lftp -d -u "${{ secrets.FTP_USER }},${{ secrets.FTP_KEY }}" ${{ secrets.FTP_HOST }} << EOF
          ls
          bye
          EOF

      - name: 🔍 Test Verbindung mit lftp (FTPS)
        run: |
          echo "TEST FTP CONNECTION (lftp, FTPS)"
          lftp -d -u "${{ secrets.FTP_USER }},${{ secrets.FTP_KEY }}" ftps://$(echo "${{ secrets.FTP_HOST }}" | sed 's|^ftp://||') << EOF
          ls
          bye
          EOF

      - name: 🔍 Test Verbindung mit lftp (FTPS, Zertifikat ignorieren)
        run: |
          echo "TEST FTP CONNECTION (lftp, FTPS, ignore cert)"
          lftp -d -u "${{ secrets.FTP_USER }},${{ secrets.FTP_KEY }}" ftps://$(echo "${{ secrets.FTP_HOST }}" | sed 's|^ftp://||') << EOF
          set ssl:verify-certificate no
          ls
          bye
          EOF
